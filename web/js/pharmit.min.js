function Feature(e,t,a){var n=this;this.obj={},this.shape=null,this.selected=!1,this.updateViewer=function(){},this.container=$("<div>").appendTo(t).addClass("featurediv"),this.container.get(0).feature=this,this.container.disableSelection();var i=$("<h3></h3>").appendTo(this.container);this.enabled=$("<div>").addClass("toggle toggle-light togglediv").appendTo(i).toggles().on("toggle",function(e,t){t?(n.obj.enabled=!0,n.container.addClass("enabledfeature")):(n.obj.enabled=!1,n.container.removeClass("enabledfeature")),n.updateViewer()}).click(function(){return!1});var o=$("<div>").addClass("featurenamediv").appendTo(i),r=$("<span>").addClass("featurenameheading").appendTo(o),s=$("<div>").addClass("featureclose").appendTo(i).click(function(){n.shape&&e.removeFeature(n.shape),n.container.feature=null,n.container.remove()}),d=($("<span>").addClass("ui-icon-circle-close ui-icon").appendTo(s),$("<span>").appendTo(o).addClass("featuresummary"));d.append($(document.createTextNode("("))),this.xsummary=$("<span>").appendTo(d),d.append($(document.createTextNode(","))),this.ysummary=$("<span>").appendTo(d),d.append($(document.createTextNode(","))),this.zsummary=$("<span>").appendTo(d),d.append($(document.createTextNode(") Radius "))),this.rsummary=$("<span>").appendTo(d);var l=$("<div>").appendTo(this.container),p=this.select=$('<select name="featurename">').addClass("featureselect").appendTo(l);$.each(this.featureNames,function(e,t){$('<option value="'+t+'">'+t+"</option>").appendTo(p)}),p.change(function(){var e=this.value;n.obj.name=e,r.text(e),"Aromatic"==e||"HydrogenDonor"==e||"HydrogenAcceptor"==e?(n.orientdiv.show(),n.sizediv.hide(),n.obj.hasvec=!0):"Hydrophobic"==e?(n.orientdiv.hide(),n.sizediv.show(),n.obj.hasvec=!1):(n.orientdiv.hide(),n.sizediv.hide(),n.obj.hasvec=!1),n.updateViewer()}),p.selectmenu({width:"12em",change:function(){p.trigger("change")}});var u=$("<div>").appendTo(l).addClass("locationdiv"),c=function(e,t){var a=function(){e.change()};return t.spin=t.stop=t.change=a,t};$("<label>x:</label>").appendTo(u),this.x=$("<input>").appendTo(u).addClass("coordinput").change(function(){var e=parseFloat(this.value);n.xsummary.text(numeral(e).format("0.[00]")),n.obj.x=e,n.updateViewer()}),this.x.spinner(c(n.x,{step:.1,numberFormat:"n"})),$("<label>y:</label>").appendTo(u),this.y=$("<input>").appendTo(u).addClass("coordinput"),this.y.spinner(c(n.y,{step:.1,numberFormat:"n"})).change(function(){var e=parseFloat(this.value);n.ysummary.text(numeral(e).format("0.[00]")),n.obj.y=e,n.updateViewer()}),$("<label>z:</label>").appendTo(u),this.z=$("<input>").appendTo(u).addClass("coordinput"),this.z.spinner(c(n.z,{step:.1,numberFormat:"n"})).change(function(){var e=parseFloat(this.value);n.zsummary.text(numeral(e).format("0.[00]")),n.obj.z=e,n.updateViewer()}),$("<label>Radius:</label>").appendTo(u),this.radius=$("<input>").appendTo(u).addClass("radiusinput"),this.radius.spinner(c(n.radius,{step:.1,numberFormat:"n"})).change(function(){n.rsummary.text(numeral(this.value).format("0.[00]")),n.obj.radius=this.value,n.updateViewer()});var h=this.orientdiv=$("<div>").appendTo(l).addClass("orientdiv"),m=null,f=null,v=function(e,t){var a=e*Math.PI/180,i=t*Math.PI/180;n.obj.svector={x:Math.sin(a)*Math.cos(i),y:Math.sin(a)*Math.sin(i),z:Math.cos(a)}};this.orientenabled=$('<input type="checkbox">').appendTo(h).change(function(){$(this).prop("checked")?(m.spinner("option","disabled",!1),f.spinner("option","disabled",!1),n.obj.vector_on=0):(m.spinner("option","disabled",!0),f.spinner("option","disabled",!0),n.obj.vector_on=1,v(m.val(),f.val())),n.updateViewer()}),$("<label>&theta;:</label>").appendTo(h),m=this.theta=$("<input>").appendTo(h).addClass("orientinput"),this.theta.spinner(c(n.theta,{step:1,numberFormat:"n"})).change(function(){v(m.val(),f.val()),n.updateViewer()}),$("<label>&phi;:</label>").appendTo(h),f=this.phi=$("<input>").appendTo(h).addClass("orientinput"),this.phi.spinner(c(n.theta,{step:1,numberFormat:"n"})).change(function(){v(m.val(),f.val()),n.updateViewer()}),this.orientdiv.hide();var b=this.sizediv=$("<div>").appendTo(l).addClass("sizediv");this.minsize=$("<input>").appendTo(b).addClass("sizeinput"),this.minsize.spinner(c(n.minsize,{step:1,numberFormat:"n"})).change(function(){n.obj.minsize=this.value,n.updateViewer()}),$("<label> &le; #Atoms &le;</label>").appendTo(b),this.maxsize=$("<input>").appendTo(b).addClass("sizeinput"),this.maxsize.spinner(c(n.maxsize,{step:1,numberFormat:"n"})).change(function(){n.obj.maxsize=this.value,n.updateViewer()}),this.sizediv.hide(),this.setFeature(a),delete this.updateViewer,this.viewer=e,this.updateViewer(),t.accordion("refresh"),t.accordion("option","active",t.children().length-1)}Feature.prototype.setFeature=function(e){if(this.select.val(e.name).trigger("change"),this.select.selectmenu("refresh"),this.x.val(e.x).trigger("change"),this.y.val(e.y).trigger("change"),this.z.val(e.z).trigger("change"),this.radius.val(e.radius).trigger("change"),this.enabled.toggles(e.enabled),this.obj.enabled=!!e.enabled,this.orientenabled.prop("checked",1==e.vector_on).trigger("change"),$.isNumeric(e.minsize)?this.minsize.val(e.minsize).trigger("change"):this.obj.minsize="",$.isNumeric(e.maxsize)?this.maxsize.val(e.maxsize).trigger("change"):this.obj.maxsize="",e.svector){var t=e.svector.x,a=e.svector.y,n=e.svector.z,i=180*Math.acos(n/Math.sqrt(t*t+a*a+n*n))/Math.PI,o=180*Math.atan2(a,t)/Math.PI;this.theta.val(i).trigger("change"),this.phi.val(o).trigger("change")}else this.obj.svector={x:1,y:0,z:0}},Feature.prototype.featureNames=["Aromatic","HydrogenDonor","HydrogenAcceptor","Hydrophobic","NegativeIon","PositiveIon"],Feature.prototype.updateViewer=function(){if(null!==this.shape&&this.viewer.removeFeature(this.shape),this.obj.enabled){var e=this;this.shape=this.viewer.addFeature(this.obj,function(){e.selected?e.deselectFeature():e.selectFeature()})}},Feature.prototype.selectFeature=function(){this.viewer.selectFeature(this.shape),this.container.addClass("selectedFeature"),this.selected=!0},Feature.prototype.deselectFeature=function(){this.viewer.unselectFeature(this.shape),this.container.removeClass("selectedFeature"),this.selected=!1},function(e){e.support.cssPseudoClasses=function(){try{var t=e("<input type='checkbox' checked/>").appendTo("body"),a=e('<style type="text/css" />').appendTo("head");a.text("input:checked {width: 200px; display: none}");var n="200px"==t.css("width");return t.remove(),a.remove(),n}catch(i){return!1}}(),e.fn.fileinput=function(t){var a=this;return t||(t='<button class="fileinput">Browse...</button>'),a.each(function(){var a=e(this);a.wrap('<div class="fileinput-wrapper" style=" position: relative; display: inline-block;" />'),a.parent().mousemove(function(t){var a,n,i=e(this);a=i.offset().left,n=i.offset().top,i.find("input").css({left:t.pageX-a-i.find("input[type=file]").width()+30,top:t.pageY-n-10})}),a.attr("tabindex","-1").css({filter:"alpha(opacity=0)","-moz-opacity":0,opacity:0,position:"absolute","z-index":-1}),a.before(t),a.prev().addClass("fileinput"),e.support.cssPseudoClasses?(a.prev(".fileinput").click(function(){a.click()}),a.prev(":submit.fileinput").click(function(e){e.preventDefault()})):(a.css({"z-index":"auto",cursor:"pointer"}),a.prev(".fileinput").css("z-index",-1),a.removeAttr("tabindex"),a.prev(".fileinput").attr("tabindex","-1"),a.hover(function(){e(this).prev(".fileinput").addClass("hover")},function(){e(this).prev(".fileinput").removeClass("hover")}).focusin(function(){e(this).prev(".fileinput").addClass("focus")}).focusout(function(){e(this).prev(".fileinput").removeClass("focus")}).mousedown(function(){e(this).prev(".fileinput").addClass("active")}).mouseup(function(){e(this).prev(".fileinput").removeClass("active")}))}),a}}(jQuery);var Pharmit={};$(document).ready(function(){var e=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",a=new RegExp(t),n=a.exec(window.location.href);return null===n?null:n[1]};Pharmit.server="/fcgi-bin/pharmitserv.fcgi";var t=$("#pharmit"),a=new Pharmit.Viewer(t),n=(new Pharmit.PharmaResults(t,a),new Pharmit.Query(t,a));e("SESSION")&&$.get(decodeURI(e("SESSION")),function(e){n.loadSession(e)}),$("button, input[type='button'], input[type='submit']").button().bind("mouseup",function(){$(this).blur()})});var Pharmit=Pharmit||{};Pharmit.PharmaResults=function(){function e(){}return e}();var Pharmit=Pharmit||{};Pharmit.Query=function(){function e(e,a){var n=$("<div>").addClass("pharmit_query"),i=null,o=null,r=null,s=null,d=null,l=null,p=null,u=function(){},c=function(e,t){if(e.files.length>0){var a=e.files[0],n=new FileReader;n.onload=function(e){t(e.target.result,a.name)},n.readAsText(a),$(e).val("")}},h=function(){},m=function(e,t){s=e,d=t,a.setReceptor(e,t)},f=function(){var e=o.children().detach();e.sort(function(e,t){var a=e.feature.obj,n=t.feature.obj;return a.enabled!=n.enabled?n.enabled-a.enabled:a.name!=n.name?a.name.localeCompare(n.name):a.radius-n.radius}),o.append(e)},v=this.loadSession=function(e){var t=$.parseJSON(e);o.detach(),o.empty(),t.points&&$.each(t.points,function(e,t){new Feature(a,o,t)}),o.accordion("option","active",!1),o.accordion("refresh"),r.after(o),$.each(t,function(e,t){var a=$("input[name="+e+"]");a.length&&a.val(t)}),s=t.receptor,d=t.recname,a.setReceptor(s,d),t.sdf?(l=decodeURIComponent(t.sdf),p=l.match(/^@<TRIPOS>MOLECULE/)?".mol2":l.match(/^HETATM/)||l.match(/^ATOM/)?".pdb":l.match(/^.*\n.*\n.\s*(\d+)\s+(\d+)/)?".sdf":".xyz"):(l=t.ligand,p=t.ligandFormat),a.setLigand(l,p),t.backgroundcolor&&$("#"+t.backgroundcolor).prop("checked",!0).change(),a.setView(t.view)},b=function(){var e={};return e.points=[],$.each(o.children(),function(t,a){e.points.push(a.feature.obj)}),$.each($("[name]",n),function(t,a){a.name&&(e[a.name]=a.value)}),e.backgroundcolor="whiteBackground",$("#blackBackground").prop("checked")&&(e.backgroundcolor="blackBackground"),e.ligand=l,e.ligandFormat=p,e.receptor=s,e.recname=d,e},g=function(){var e=Pharmit.server+'?cmd=savedata&type="text%2Fphjson"&fname="pharmit.json"',t=$("<form>",{action:e,method:"post"}),a=b();t.append($("<input>",{name:"data",type:"hidden",value:JSON.stringify(a,null,4)})),t.appendTo(document.body),t.submit(),$(t).remove()},y=function(e,t){var a=$("<div>").addClass("searchdiv"),n=$("<button>Search "+t[0]+"</button>").appendTo(a).button(),i=$("<button>Select subset to search</button>").appendTo(a).button({text:!1,icons:{primary:"ui-icon-triangle-1-s"}});a.buttonset();for(var o=$("<ul>").appendTo($("body")).addClass("floatmenu"),r=[],s=0,d=t.length;d>s;s++)r[s]="<li>"+t[s]+"</li>";o.append(r),o.hide().menu().on("menuselect",function(e,t){n.button("option","label","Search "+t.item.text())}),n.click(u),i.click(function(){var e=o.show().position({my:"left top",at:"left buttom",of:this});return $(document).one("click",function(){e.hide()}),!1}),e.prepend(a)};n.resizable({handles:"e",resize:function(e,t){a.setLeft(t.size.width)}}),n.disableSelection();var T=$("<div>").appendTo(n).addClass("queryheader");y(T,["MolPort","ZINC"]);var w=$("<div>").appendTo(T),x=$("<button>Load Features...</button>").button(),C=$("<button>Load Receptor...</button>").button();e.append(n);$('<input type="file">').appendTo(w).fileinput(x).change(h),$('<input type="file">').appendTo(w).fileinput(C).change(function(){c(this,m)});n.detach();var k=$("<div>").appendTo(n).addClass("querybody"),z=$("<div>").appendTo(k);r=$("<div>Pharmacophore</div>").appendTo(z).addClass("queryheading"),o=$("<div>").appendTo(z),o.accordion({header:"> div > h3",animate:!0,collapsible:!0,heightStyle:"content",beforeActivate:function(e,t){var a=null;t.newHeader.length>0&&(a=t.newHeader.parent(),a.get(0).feature.selectFeature()),t.oldHeader.length>0&&(a=t.oldHeader.parent(),a.get(0).feature.deselectFeature())}}).sortable({axis:"y",handle:"h3",stop:function(e,t){t.item.children("h3").triggerHandler("focusout"),$(this).accordion("refresh")}});var F=($("<button>Add</button>").appendTo(z).button({text:!0,icons:{secondary:"ui-icon-circle-plus"}}).click(function(){new Feature(a,o,t)}),$("<button>Sort</button>").appendTo(z).button({text:!0,icons:{secondary:"ui-icon ui-icon-carat-2-n-s"}}).click(f),$("<div>").appendTo(k));$("<div>Filters</div>").appendTo(F).addClass("queryheading");var S=$("<div>").appendTo(F),M=$("<h3>Hit Reduction<br></h3>").appendTo(S),P=($('<span class="headingsummary"></span>').appendTo(M),$('<div class="hitreduction"></div>').appendTo(S)),j=$("<div>").addClass("filterrow").appendTo(P);j.append('<label title="Maximum number of orientations returned for each conformation" value="1" for="reduceorienttext">Max Hits per Conf:</label>');$('<input id="reduceorienttext" name="max-orient">').appendTo(j).spinner();j=$("<div>").addClass("filterrow").appendTo(P),j.append('<label title="Maximum number of conformations returned for each compound" value="1" for="reduceconfstext">Max Hits per Mol:</label>');$('<input id="reduceconfstext" name="reduceConfs">').appendTo(j).spinner();j=$("<div>").addClass("filterrow").appendTo(P),j.append('<label title="Maximum number of hits returned" value="1" for="reducehitstext">Max Total Hits:</label>');$('<input id="reducehitstext" name="max-hits">').appendTo(j).spinner();M=$("<h3>Hit Screening<br></h3>").appendTo(S);var V=($('<span class="headingsummary"></span>').appendTo(M),$('<div class="hitscreening"></div>').appendTo(S));j=$("<div>").addClass("filterrow").appendTo(V);$('<input id="minmolweight" name="minMolWeight">').appendTo(j).spinner();j.append($('<label title="Minimum/maximum molecular weight (weights are approximate)" value="1" for="maxmolweight">&le;  Molecular Weight &le;</label>'));$('<input id="maxmolweight" name=maxMolWeight>').appendTo(j).spinner();j=$("<div>").addClass("filterrow").appendTo(V);$('<input id="minnrot" name="minrotbonds">').appendTo(j).spinner();j.append($('<label title="Minimum/maximum number of rotatable bonds" value="1" for="maxnrot"> &le;  Rotatable Bonds &le;</label>'));$('<input id="maxnrot" name="maxrotbonds">').appendTo(j).spinner();S.accordion({animate:!0,collapsible:!0,heightStyle:"content"}),i=$("<div>").appendTo(k),$("<div>Visualization</div>").appendTo(i).addClass("queryheading"),a.appendViewerControls(i);var R=$("<div>").appendTo(n).addClass("queryfooter");e.append(n);{var H=$("<button>Load Session...</button>").button();$('<input type="file">').appendTo(R).fileinput(H).change(function(){c(this,v)}),$("<button>Save Session...</button>").appendTo(R).button().click(g)}a.setLeft(n.width())}var t={name:"Hydrophobic",x:0,y:0,z:0,radius:1,enabled:!0,vector_on:0,minsize:"",maxsize:"",svector:null,hasvec:!1};return e}();var Pharmit=Pharmit||{};Pharmit.Viewer=function(){"use strict";function e(e){var t=($3Dmol.elementColors,{none:"None",rasmol:"RasMol",whiteCarbon:"White",greenCarbon:"Green",cyanCarbon:"Cyan",magentaCarbon:"Magenta",yellowCarbon:"Yellow",orangeCarbon:"Orange",purpleCarbon:"Purple",blueCarbon:"Blue"}),a={left:0,right:0},n={Aromatic:"purple",HydrogenDonor:"0xeeeeee",HydrogenAcceptor:"orange",Hydrophobic:"green",NegativeIon:"red",PositiveIon:"blue"},i={Ligand:{model:null,style:{stick:{radius:.15}}},Receptor:{model:null,style:{cartoon:{},line:{linewidth:3}}},Results:{model:null,style:{stick:{}}}},o={sphere:{radius:.2}},r=null,s={map:{prop:"partialCharge",scheme:new $3Dmol.Gradient.RWB(-.8,.8)},opacity:.8},d=null,l=[],p=function(e){if(!e)return"";var t=e.split(".");return t.length<=1?"":t.pop()},u=function(e,a,n){var o=$("<div>").appendTo(n),r=e+"MolStyleSelect";$('<label for="'+r+'">'+e+" Style</label>").appendTo(o).addClass("stylelabel");var s=$('<select name="'+r+'" id="'+r+'">').appendTo(o).addClass("styleselector");$.each(t,function(e,t){$('<option value="'+e+'">'+t+"</option>").appendTo(s)}),s.val(a),s.selectmenu({width:"8em",appendTo:n,change:function(){s.change()},position:{my:"left top",at:"left bottom",collision:"flip"}}),s.change(function(){var t=this.value,a=i[e].style;$.each(a,function(e,a){a.colorscheme=t});var n=i[e].model;n&&n.setStyle({},a),s.selectmenu("refresh"),d.render()}),s.change()};this.appendViewerControls=function(e){u("Ligand","rasmol",e,null),u("Results","rasmol",e,null),u("Receptor","rasmol",e,null),$('<label for="surfaceopacity">Receptor Surface Opacity</label>').appendTo(e);var t=$("<div>").addClass("surfacetransparencydiv").appendTo(e);$('<div id="surfaceopacity" name="surfaceopacity">').appendTo(t).slider({animate:"fast",step:.05,min:0,max:1,value:.8,change:function(e,t){s.opacity=t.value,null!==r&&d.setSurfaceMaterialStyle(r,s),d.render()}}),$('<label for="backgroundcolor">Background Color</label>').appendTo(e);var a=$('<div id="backgroundcolor">').appendTo(e);$('<input type="radio" id="whiteBackground" name="backgroundcolor"><label for="whiteBackground">White</label>').appendTo(a).change(function(){$(this).prop("checked")&&d.setBackgroundColor("white"),a.buttonset("refresh")}).prop("checked",!0),$('<input type="radio" id="blackBackground" name="backgroundcolor"><label for="blackBackground">Black</label>').appendTo(a).change(function(){$(this).prop("checked")&&d.setBackgroundColor("black"),a.buttonset("refresh")}),a.buttonset()},this.setReceptor=function(e,t){var a=i.Receptor.model;if(a&&d.removeModel(a),a=null,null!==r&&d.removeSurface(r),r=null,e){var n=p(t);a=d.addModel(e,n),a.setStyle({},i.Receptor.style),a.setStyle({bonds:0},o),i.Receptor.model=a,d.render(),d.mapAtomProperties($3Dmol.applyPartialCharges,{model:a}),r=d.addSurface($3Dmol.SurfaceType.VDW,s,{model:a},{bonds:0,invert:!0}),d.zoomTo()}d.render()},this.setLigand=function(e,t){var a=i.Ligand.model;if(a&&d.removeModel(a),a=null,e){var n=p(t);a=d.addModel(e,n),a.setStyle({},i.Ligand.style),i.Ligand.model=a,d.zoomTo({model:a})}d.render()},this.setView=function(e){e&&d.setView(e)},this.getView=function(){return d.getView()},this.addFeature=function(e,t){var a={center:{x:e.x,y:e.y,z:e.z},radius:e.radius,color:n[e.name],wireframe:!0,linewidth:1.5,clickable:!0,callback:t},i={sphere:null,arrows:[],label:null};return i.sphere=d.addSphere(a),d.render(),l.push(i),l.length-1},this.selectFeature=function(e){var t=l[e];t&&t.sphere&&(t.sphere.updateStyle({wireframe:!1}),d.render())},this.unselectFeature=function(e){var t=l[e];t&&t.sphere&&(t.sphere.updateStyle({wireframe:!0}),d.render())},this.removeFeature=function(e){var t=l[e];for(t&&(t.sphere&&d.removeShape(t.sphere),$.each(t.arrows,function(e,t){d.removeShape(t)}),t.label&&d.removeLabel(t.label),d.render()),delete l[e];l.length>0&&"undefined"==typeof l[l.length-1];)l.pop()},this.setLeft=function(e){var t=e-a.left;a.left=e,d.translate(t,0)},this.setRight=function(e){var t=a.right-e;a.right=e,d.translate(t,0)},d=new $3Dmol.GLViewer(e),d.setBackgroundColor("white")}return e}();